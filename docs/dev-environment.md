# Development Environment Guide

## Overview

Zero Waste Frankfurt uses a **two-environment setup** to ensure safe development and deployment:

| Environment | Project ID | Region | Branch | Usage |
|-------------|------------|--------|--------|-------|
| **Development** | lccpndhssuemudzpfvvg | eu-central-1 | Any | Local dev, testing migrations, debugging |
| **Production** | rivleprddnvqgigxjyuc | eu-central-1 | main | Live site at map.zerowastefrankfurt.de |

## Getting Started

### 1. Clone and Install

```bash
git clone https://github.com/YOUR_ORG/zerowaste-frankfurt.git
cd zerowaste-frankfurt
npm install
```

### 2. Configure Environment

```bash
# Copy example files
cp .env.development.example .env.development
cp .env.production.example .env.production

# Fill in anon keys from Supabase Dashboard → Settings → API
```

The project uses separate environment files:
- `.env.development` → Loaded by `npm run dev`
- `.env.production` → Loaded by `npm run build`

URLs are pre-configured, you just need to add the anon keys.

### 3. Run Development Server

```bash
npm run dev
```

Open http://localhost:5173 - you should see a **"DEV"** badge in the bottom-left corner indicating you're connected to the development environment.

## Database Workflow

### Creating a Migration

```bash
# Create migration file
npx supabase migration new add_new_feature

# This creates: supabase/migrations/YYYYMMDDHHMMSS_add_new_feature.sql
```

Edit the generated file with your SQL changes:

```sql
-- Example: Add new column
ALTER TABLE locations
ADD COLUMN new_field TEXT;
```

### Testing Migrations Locally

```bash
# Link to DEV project
npx supabase link --project-ref lccpndhssuemudzpfvvg

# Push migration to DEV
npx supabase db push
```

This applies the migration to the development database. Test your changes thoroughly before committing.

### Migration Naming Convention

**Format:** `YYYYMMDDHHMMSS_description.sql`

Rules:
- Use lowercase
- Use underscores for spaces
- Be descriptive but concise
- Timestamp auto-generated by CLI

Good examples:
- `20260114120000_add_user_preferences.sql`
- `20260114130000_update_location_schema.sql`
- `20260114140000_create_search_index.sql`

Bad examples:
- `migration.sql` (no timestamp)
- `AddUserPreferences.sql` (not lowercase)
- `20260114120000.sql` (no description)

### Deploying to Production

**Never push directly to production!** Use the automated workflow:

1. Create feature branch:
   ```bash
   git checkout -b feature/add-new-field
   ```

2. Create and test migration in DEV:
   ```bash
   npx supabase migration new add_new_field
   # Edit the migration file
   npx supabase db push  # Test in DEV
   ```

3. Commit and push:
   ```bash
   git add supabase/migrations/
   git commit -m "feat: add new field to locations"
   git push origin feature/add-new-field
   ```

4. Create Pull Request to `main`
   - CI validates migration file naming
   - CI checks for dangerous operations (DROP DATABASE, TRUNCATE, etc.)

5. Merge to `main`
   - GitHub Actions automatically deploys to production
   - Check workflow status in Actions tab

### Checking Migration Status

```bash
# List all migrations and their status
npx supabase migration list

# Check for drift between local and remote
npx supabase db diff
```

## Edge Functions

### Local Development

```bash
# Link to DEV project
npx supabase link --project-ref lccpndhssuemudzpfvvg

# Deploy function to DEV
npx supabase functions deploy submit-location

# View live logs
npx supabase functions logs submit-location --tail
```

### Function Secrets

Dev and production have separate secrets. Set them per environment:

```bash
# Link to desired environment first
npx supabase link --project-ref <project-id>

# Set secrets
npx supabase secrets set AWS_ACCESS_KEY_ID=xxx
npx supabase secrets set AWS_SECRET_ACCESS_KEY=xxx
npx supabase secrets set AWS_REGION=eu-central-1

# List current secrets (values hidden)
npx supabase secrets list
```

**Required secrets for Edge Functions:**
- `AWS_ACCESS_KEY_ID` - SES email sending
- `AWS_SECRET_ACCESS_KEY` - SES credentials
- `AWS_REGION` - AWS region (eu-central-1)
- `FROM_EMAIL` - Email sender address (noreply@zerowastefrankfurt.de)

### Deploying to Production

Edge Functions deploy automatically via GitHub Actions on merge to main. To deploy manually:

```bash
# Link to PROD
npx supabase link --project-ref rivleprddnvqgigxjyuc

# Deploy all functions
npx supabase functions deploy

# Or deploy specific function
npx supabase functions deploy submit-location
```

## Frontend Deployment

### Manual Deployment

```bash
# Simply run (uses .env.production automatically)
npm run deploy:frontend
```

The deploy script:
1. Loads `.env.production` automatically
2. Builds the app with production credentials
3. Syncs to S3 bucket
4. Invalidates CloudFront cache

Make sure `.env.production` has valid credentials before deploying.

### Automated Deployment (Optional)

Frontend deployment can be automated via GitHub Actions. See `.github/workflows/deploy-frontend.yml`.

## Environment Detection

The app automatically detects which environment it's running in:

```typescript
// src/lib/supabase.ts
export const isProduction = supabaseUrl.includes('rivleprddnvqgigxjyuc')
export const isDevelopment = !isProduction
```

In development, an **EnvironmentBadge** component displays "DEV" in the bottom-left corner. This helps developers know they're not affecting production data.

## Troubleshooting

### Issue: Can't connect to Supabase

**Symptoms:**
- "Failed to fetch" errors
- Empty location list
- Login doesn't work

**Solutions:**
1. Verify `.env.development` has correct DEV credentials
2. Check Supabase dashboard - free tier projects pause after inactivity
3. Ensure you're using DEV project ID, not PROD

### Issue: Migration failed

**Symptoms:**
- GitHub Actions workflow failed
- "Migration already applied" error
- SQL syntax error

**Solutions:**

1. Check error in GitHub Actions log
2. Fix the SQL syntax
3. If migration was partially applied:
   ```bash
   # Mark as reverted
   npx supabase migration repair <timestamp> --status reverted

   # Fix the migration file
   # Push again
   npx supabase db push
   ```

### Issue: Edge Function not working

**Symptoms:**
- Email verification not sending
- Location submission fails
- 500 errors

**Solutions:**

```bash
# Check function logs
npx supabase functions logs submit-location --tail

# Common issues:
# 1. Missing secrets
npx supabase secrets list

# 2. Wrong secrets (prod vs dev)
npx supabase link --project-ref lccpndhssuemudzpfvvg  # Check which project
npx supabase secrets set AWS_ACCESS_KEY_ID=...  # Reset if needed

# 3. Code error - check logs for stack trace
```

### Issue: Build fails with "Missing Supabase environment variables"

**Solution:**

```bash
# For development, ensure .env.development exists
cat .env.development

# For production, ensure .env.production exists
cat .env.production

# Copy from examples if missing
cp .env.development.example .env.development
cp .env.production.example .env.production
# Then fill in the anon keys
```

### Issue: RLS policy errors (42501)

**Symptoms:**
- Location submission fails
- Can't read inserted data
- "Row-level security policy" error

**Solutions:**

See [docs/supabase.md](supabase.md) for comprehensive RLS troubleshooting. Common fixes:

1. Don't use `.select()` after `.insert()` for anonymous users
2. Generate UUID client-side instead of relying on server return
3. Verify GRANT permissions exist for anon role

## CI/CD Workflows

### Pull Request Validation

When you create a PR, GitHub Actions runs:

1. **Type checking** (`npm run type-check`)
2. **Unit tests** (`npm run test`)
3. **Build verification** (`npm run build`)
4. **Migration validation** (if migrations changed)
   - Checks filename format
   - Checks for dangerous operations (DROP, TRUNCATE)

### Main Branch Deployment

When PR is merged to `main`, GitHub Actions:

1. **Deploys database migrations** to production
2. **Deploys Edge Functions** to production
3. **(Optional) Deploys frontend** to S3/CloudFront

Check workflow status: **Actions** tab in GitHub repo

## Quick Reference

```bash
# Link to DEV
npx supabase link --project-ref lccpndhssuemudzpfvvg

# Link to PROD
npx supabase link --project-ref rivleprddnvqgigxjyuc

# Create migration
npx supabase migration new name_here

# Push migrations
npx supabase db push

# Deploy Edge Function
npx supabase functions deploy function-name

# View function logs
npx supabase functions logs function-name --tail

# List secrets
npx supabase secrets list

# Set secret
npx supabase secrets set KEY=value

# Check migration status
npx supabase migration list

# Check database diff
npx supabase db diff
```

## Best Practices

### Do:
- Always test migrations in DEV first
- Use descriptive migration names
- Keep migrations small and focused
- Test Edge Functions in DEV before deploying
- Use environment badge to know which environment you're in
- Commit migration files to git

### Don't:
- Never modify migration files after they're applied
- Never push directly to production database
- Never commit `.env` files with secrets
- Don't use DROP or TRUNCATE in migrations without careful review
- Don't deploy to production without testing in DEV first

## Security Notes

- **Never commit secrets** - `.env.development` and `.env.production` are in `.gitignore`
- **Service role keys** - Never expose in client code
- **Admin users** - Create manually, never via migration
- **RLS policies** - Must be identical in DEV and PROD
- **Edge Function secrets** - Set separately per environment

## Getting Help

- **Supabase issues:** Check [docs/supabase.md](supabase.md)
- **RLS problems:** See RLS section in [docs/supabase.md](supabase.md)
- **General questions:** Check [CLAUDE.md](../CLAUDE.md) or [README.md](../README.md)
- **Testing:** See [docs/testing-strategy.md](testing-strategy.md)
