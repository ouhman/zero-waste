# Phase 2 Test Fix Summary - AdminLogin.test.ts

## Problem
The test file `tests/component/AdminLogin.test.ts` was testing password-based authentication, but the actual component (`src/views/admin/LoginView.vue`) implements magic link authentication with email-only input.

### Original Test Failures
All 5 tests failed with "Cannot call setValue on an empty DOMWrapper" because they tried to interact with `input[type="password"]` which doesn't exist in the component.

## Solution
Completely rewrote the test suite to align with the actual magic link authentication flow.

## Changes Made

### 1. Updated Supabase Mock
**Before:**
```typescript
vi.mock('@/lib/supabase', () => ({
  supabase: {
    auth: {
      signInWithPassword: vi.fn()
    }
  }
}))
```

**After:**
```typescript
vi.mock('@/lib/supabase', () => ({
  supabase: {
    auth: {
      signInWithOtp: vi.fn()  // Magic link auth
    },
    rpc: vi.fn()  // For rate limiting and admin check
  }
}))
```

### 2. Removed Router Dependency
Magic link auth doesn't redirect on submit (it shows success message), so removed router setup and push spy tests.

### 3. Rewrote All 8 Tests

#### Test 1: "shows login form with email input only"
- Verifies email input exists
- Explicitly checks password input does NOT exist
- Verifies submit button exists

#### Test 2: "requires email to enable submit button"
- Tests button is disabled when email is empty
- Tests button becomes enabled after entering email

#### Test 3: "sends magic link via Supabase on successful admin check"
- Mocks rate limit check (allowed)
- Mocks admin email check (true)
- Verifies `supabase.rpc` called with correct parameters
- Verifies `supabase.auth.signInWithOtp` called with email and redirect URL

#### Test 4: "shows success message after sending magic link"
- Tests complete success flow
- Verifies success message appears (green background)
- Verifies form is hidden after success

#### Test 5: "shows generic success message even for non-admin emails (security)"
- Tests security feature: always shows success even for non-admin emails
- Verifies `signInWithOtp` is NOT called for non-admin emails
- Prevents email enumeration attacks

#### Test 6: "shows error when rate limited"
- Mocks rate limit exceeded
- Verifies error message appears (red background)
- Verifies `signInWithOtp` is not called when rate limited

#### Test 7: "shows loading state during authentication"
- Tests loading state (disabled button, loading text)
- Uses slow mock to verify state during async operation

#### Test 8: "handles RPC errors gracefully"
- Tests error handling for database failures
- Verifies generic error message shown (doesn't expose internals)

## Test Results
```bash
âœ“ tests/component/AdminLogin.test.ts  (8 tests) 61ms

Test Files  1 passed (1)
     Tests  8 passed (8)
```

## Key Improvements

1. **Accurate Authentication Flow**: Tests now match the actual magic link implementation
2. **Security Testing**: Added tests for security features (email enumeration prevention, rate limiting)
3. **Comprehensive Coverage**: Covers all user flows (success, rate limit, errors, loading)
4. **Better Async Handling**: Uses `flushPromises()` from @vue/test-utils for cleaner async tests
5. **Removed Unnecessary Dependencies**: No router needed for magic link flow

## Files Modified
- `/home/ouhman/projects/zerowaste-frankfurt/tests/component/AdminLogin.test.ts` (complete rewrite)

## Next Steps
All tests in Phase 2 are now passing. Ready to proceed with Phase 3 test fixes.
